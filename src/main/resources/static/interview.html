<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 面试官 - 深度交流</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* 清新柔和的亮色调色板 */
        :root {
            --bg-app: #f4f6f8;
            --bg-surface: #ffffff;
            --border-subtle: #e9ecef;
            --text-primary: #343a40;
            --text-secondary: #868e96;
            --accent-color: #4dabf7;
            --user-msg-bg: #4dabf7;
            --ai-msg-bg: #f8f9fa;
        }

        body { font-family: 'Inter', -apple-system, sans-serif; background-color: var(--bg-app); color: var(--text-primary); margin: 0; height: 100vh; display: flex; flex-direction: column; }

        /* 顶部导航更轻盈 */
        .header { background: var(--bg-surface); padding: 16px 24px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.02); z-index: 10; }
        .back-link { color: var(--text-secondary); text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 8px; transition: color 0.2s; }
        .back-link:hover { color: var(--accent-color); }
        .title { font-weight: 600; font-size: 1.1rem; color: var(--text-primary); display: flex; align-items: center; gap: 10px; }
        .title i { color: var(--accent-color); font-size: 1.2rem; }

        /* 对话区留白更多 */
        .chat-area { flex: 1; overflow-y: auto; padding: 30px 20px; max-width: 850px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .msg-row { display: flex; margin-bottom: 24px; gap: 16px; animation: fadeIn 0.4s ease forwards; }
        .msg-row.user { justify-content: flex-end; }

        /* 头像变圆，颜色温和 */
        .avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; background: var(--bg-surface); border: 1px solid var(--border-subtle); flex-shrink: 0; box-shadow: 0 2px 6px rgba(0,0,0,0.03); }
        .msg-row.ai .avatar { color: var(--accent-color); }
        .msg-row.user .avatar { background: var(--user-msg-bg); color: white; border: none; box-shadow: 0 3px 8px rgba(77, 171, 247, 0.3); }

        /* 气泡圆角加大，像飞书/微信 */
        .bubble { padding: 14px 20px; border-radius: 20px; max-width: 75%; background: var(--ai-msg-bg); border: 1px solid var(--border-subtle); line-height: 1.6; font-size: 0.95rem; color: #495057; }
        .msg-row.ai .bubble { border-top-left-radius: 4px; }
        .msg-row.user .bubble { background: var(--user-msg-bg); color: white; border: none; border-top-right-radius: 4px; box-shadow: 0 3px 8px rgba(77, 171, 247, 0.2); }

        /* 底部输入框区域悬浮感 */
        .input-area { background: var(--bg-surface); padding: 20px; border-top: 1px solid var(--border-subtle); display: flex; justify-content: center; box-shadow: 0 -4px 20px rgba(0,0,0,0.02); }
        .input-box { max-width: 850px; width: 100%; display: flex; gap: 12px; }
        input[type="text"] { flex: 1; padding: 14px 22px; border-radius: 24px; border: 1px solid var(--border-subtle); background: var(--bg-app); color: var(--text-primary); outline: none; font-size: 1rem; transition: all 0.3s ease; }
        input[type="text"]:focus { border-color: var(--accent-color); background: #fff; box-shadow: 0 0 0 4px rgba(77, 171, 247, 0.1); }

        /* 按钮圆润无压迫感 */
        .btn { padding: 10px 20px; border-radius: 20px; border: 1px solid var(--border-subtle); cursor: pointer; font-weight: 500; background: var(--bg-surface); color: var(--text-primary); transition: all 0.2s; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .btn:hover { background: var(--bg-app); border-color: #ced4da; }
        .btn.primary { background: var(--accent-color); color: white; border: none; padding: 0 24px; border-radius: 24px; box-shadow: 0 4px 12px rgba(77, 171, 247, 0.3); }
        .btn.primary:hover { background: #339af0; transform: translateY(-1px); box-shadow: 0 6px 15px rgba(77, 171, 247, 0.4); }

        /* 优化 Markdown 中的代码块样式 */
        .bubble pre { background: #e9ecef; padding: 12px; border-radius: 10px; overflow-x: auto; font-size: 0.85rem; border: 1px solid #dee2e6; }
        .bubble code { font-family: Consolas, Monaco, monospace; background: rgba(0,0,0,0.04); padding: 2px 6px; border-radius: 4px; color: #e64980; }
        .msg-row.user .bubble code { background: rgba(255,255,255,0.2); color: #fff; }
        .bubble p { margin-top: 0; }
        .bubble p:last-child { margin-bottom: 0; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="header">
    <a href="/" class="back-link"><i class="fas fa-arrow-left"></i> 退出面试</a>
    <div class="title"><i class="fas fa-user-tie"></i> 技术拷问模式</div>
    <button class="btn" onclick="document.getElementById('fileInput').click()"><i class="fas fa-file-pdf" style="color:#fa5252;"></i> 发送简历</button>
    <input type="file" id="fileInput" accept=".pdf" style="display: none;" onchange="uploadResume(this)">
</div>

<div class="chat-area" id="chatArea">
    <div class="msg-row ai">
        <div class="avatar"><i class="fas fa-user-tie"></i></div>
        <div class="bubble">你好，我是今天的技术面试官。把你的简历发过来吧，然后我们直接开始。</div>
    </div>
</div>

<div class="input-area">
    <div class="input-box">
        <input type="text" id="userInput" placeholder="输入你的回答..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button class="btn primary" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<script>
    const chatArea = document.getElementById('chatArea');
    const userInput = document.getElementById('userInput');
    let chatId = localStorage.getItem('interview_chat_id');
    if (!chatId) { chatId = 'interview_' + Date.now(); localStorage.setItem('interview_chat_id', chatId); }

    window.onload = loadHistory;

    async function loadHistory() {
        try {
            const res = await fetch(`/interview/history?chatId=${chatId}`);
            if (res.ok) {
                const responseData = await res.json();
                // 【企业级适配】：读取 responseData.data
                if(responseData.code === 200 && responseData.data) {
                    const validHistory = responseData.data.filter(msg => !msg.content.startsWith('{"'));
                    validHistory.forEach(msg => appendMsg(msg.role, msg.content));
                }
            }
        } catch (e) {}
    }

    async function uploadResume(input) {
        if (input.files.length === 0) return;
        const formData = new FormData();
        formData.append("file", input.files[0]);

        appendMsg('ai', `收到简历：**${input.files[0].name}**，正在快速扫描你的技术栈...`);

        try {
            const res = await fetch(`/interview/upload?chatId=${chatId}`, { method: 'POST', body: formData });
            if(res.ok) {
                const responseData = await res.json();
                // 【企业级适配】：读取 responseData.data
                appendMsg('ai', responseData.code === 200 ? responseData.data : `解析异常: ${responseData.message}`);
            } else {
                appendMsg('ai', "服务器异常。");
            }
        } catch (e) { appendMsg('ai', "网络似乎有点问题。"); }
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;
        appendMsg('user', text);
        userInput.value = '';

        const loadingId = Date.now();
        appendMsg('ai', '<i class="fas fa-circle-notch fa-spin"></i> 面试官正在思考...', loadingId);

        try {
            const response = await fetch(`/interview/chat?query=${encodeURIComponent(text)}&chatId=${chatId}`);

            // 【美化拦截】判断是否触发了全局异常（限流）
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
                const errorData = await response.json();
                document.getElementById('bubble-' + loadingId).innerHTML = `
                    <div style="color: #fa5252; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-ban"></i> ${errorData.message}
                    </div>`;
                return;
            }

            const answer = await response.text();
            document.getElementById('bubble-' + loadingId).innerHTML = marked.parse(answer);
        } catch (e) {
            document.getElementById('bubble-' + loadingId).innerText = "连接断开。";
        }
    }

    function appendMsg(role, text, id = null) {
        const div = document.createElement('div');
        div.className = `msg-row ${role}`;
        const avatar = role === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-user-tie"></i>';
        const bubbleId = id ? `id="bubble-${id}"` : '';
        const parsedText = id ? text : (role === 'ai' ? marked.parse(text) : text);

        div.innerHTML = `
            ${role === 'ai' ? `<div class="avatar">${avatar}</div>` : ''}
            <div class="bubble" ${bubbleId}>${parsedText}</div>
            ${role === 'user' ? `<div class="avatar">${avatar}</div>` : ''}
        `;
        chatArea.appendChild(div);
        chatArea.scrollTop = chatArea.scrollHeight;
    }
</script>
</body>
</html>